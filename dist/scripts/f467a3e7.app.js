"use strict";function uriParamsGet(a){for(var b=new Object,c=location.search.substring(1),d=c.split("&"),e=0;e<d.length;e++){var f=d[e].indexOf("=");if(-1!=f){var g=d[e].substring(0,f),h=d[e].substring(f+1);b[g]=unescape(h)}}return a?b[a]:b}function parseParams(a){if(!a)return{};var b={};if(a=a.split("/"),a.length>1)for(var c=0;c<a.length;c++)(c+1)%2!=0&&(b[a[c]]=a[c+1]);return b}function rmbToBig(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=99999999999.99,q="零",r="壹",s="贰",t="叁",u="肆",v="伍",w="陆",x="柒",y="捌",z="玖",A="拾",B="佰",C="仟",D="万",E="亿",F="人民币 ",G="元",H="角",I="分",J="整";if(a=a.toString(),""==a)return"";if(null!=a.match(/[^,.\d]/))return"";if(null==a.match(/^((\d{1,3}(,\d{3})*(.((\d{3},)*\d{1,3}))?)|(\d+(.\d+)?))$/),a=a.replace(/,/g,""),a=a.replace(/^0+/,""),Number(a)>p)return alert("Too large a number to convert!"),"";if(e=a.split("."),e.length>1?(b=e[0],c=e[1],c=c.substr(0,2)):(b=e[0],c=""),f=new Array(q,r,s,t,u,v,w,x,y,z),g=new Array("",A,B,C),h=new Array("",D,E),i=new Array(H,I),d="",Number(b)>0){for(j=0,k=0;k<b.length;k++)l=b.length-k-1,m=b.substr(k,1),n=l/4,o=l%4,"0"==m?j++:(j>0&&(d+=f[0]),j=0,d+=f[Number(m)]+g[o]),0==o&&4>j&&(d+=h[n]);d+=G}if(""!=c)for(k=0;k<c.length;k++)m=c.substr(k,1),"0"!=m&&(d+=f[Number(m)]+i[k]);return""==d&&(d=q+G),""==c&&(d+=J),d=F+d}var loginHash=uriParamsGet("hash"),ERP=angular.module("erp",["ngCookies","ngResource","ngSanitize","ngRoute","ngGrid","ngAnimate","mgcrea.ngStrap","localytics.directives","ui.utils","ui.select","erp.passport","erp.home","erp.jxc","erp.crm","erp.common","erp.config","erp.doWorkflow","erp.commonView"]).config(["$httpProvider",function(a){var b=["$rootScope","$q",function(a,b){function c(c){return parseInt(c.data.error)>0?(a.$broadcast("event:serverError",c.data.msg),b.reject(c)):c}function d(c){var d=c.status,e=b.defer();return 401===d?(a.$broadcast("event:loginRequired"),e.promise):(403===d?a.$broadcast("event:permissionDenied"):500===d&&a.$broadcast("event:serverError"),b.reject(c))}return function(a){return a.then(c,d)}}];a.responseInterceptors.push(b)}]).run(["$http","$location",function(a){a.defaults.useXDomain=!0,a.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=UTF-8",a.defaults.headers.common.sessionHash=loginHash}]);ERP.controller("MainCtl",["$scope","$rootScope","$location","$http","erp.config","ComView","WorkflowNodeRes",function(a,b,c,d,e,f){a.$watch(function(){return c.$$url},function(){a.currentURI=encodeURI(encodeURIComponent(c.$$url))}),loginHash||(window.location.href="index.html"),a.$on("event:loginRequired",function(){window.location.href="index.html"}),a.$on("event:permissionDenied",function(){f.alert(b.i18n.lang.messages.permissionDenied,"danger")}),a.$on("event:serverError",function(a,c){c=c||b.i18n.lang.messages.serverError,f.alert(c,"danger")}),a.removeDefaultKey=function(){},b.i18n=angular.fromJson(localStorage.getItem(e.Prefix+"i18n")),(e.DEBUG||!b.i18n)&&d.get("scripts/i18n/zh-cn.json").success(function(d){b.i18n=d,localStorage.setItem(e.Prefix+"i18n",angular.toJson(d)),a.$watch(function(){return c.path()},function(){var d,e,f,g,h=["list","export","add","edit","addChild","viewChild"];d=c.path().split("/").slice(1,4),e=d[0],d[1]=d[1].replace(/Bill/gi,""),h.indexOf(d[1])>=0?(f=d[2].ucfirst(),g=d[1]):(f=d[1],g=d[2]),e=e?e:"HOME",f=f?f:"Index",g=g&&isNaN(parseInt(g))?g:"list",a.currentPage={},e in b.i18n.urlMap&&(a.currentPage.group=b.i18n.urlMap[e].name,f in b.i18n.urlMap[e].modules&&(a.currentPage.module=b.i18n.urlMap[e].modules[f].name,g in b.i18n.urlMap[e].modules[f].actions&&(a.currentPage.action=b.i18n.urlMap[e].modules[f].actions[g]instanceof Array?b.i18n.urlMap[e].modules[f].actions[g][0]:b.i18n.urlMap[e].modules[f].actions[g],a.currentPage.actionDesc=b.i18n.urlMap[e].modules[f].actions[g]instanceof Array?b.i18n.urlMap[e].modules[f].actions[g][1]:"")))})}),d.get(e.BSU+"HOME/Index/index").success(function(c){b.uesrInfo=c.user,a.$broadcast("initDataLoaded",c)}),a.$on("initDataLoaded",function(b,c){a.userInfo=c.user})}]),angular.module("erp.common",["erp.common.filters","erp.common.directives"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home/dashboard.html",controller:"MainCtl"}).when("/HOME/Index/dashboard",{templateUrl:"views/home/dashboard.html",controller:"MainCtl"}).when("/",{redirectTo:"/HOME/Index/dashboard"})}]).controller("CommonSidebarCtl",["$scope","$location",function(a,b){a.$on("initDataLoaded",function(c,d){a.navs=d.navs,a.activeSubNav="",a.checkActiveNav=function(b,c){a.openNav=c,a.activeNav=c},a.checkSubActiveNav=function(b,c){a.activeSubNav=b,a.activeShowNav=c,a.openNav=c},a.checkThirdActiveNav=function(b,c){a.activeThirdNav=b,a.activeSubNav=c},a.goPage=function(a){a&&b.url("/"+a)}})}]).controller("navHeaderCtl",["$scope",function(){}]),angular.module("erp.common.directives",["erp.formMaker"]).directive("commonform",["$compile","FormMaker",function(a,b){return{restrict:"E",scope:{config:"=",data:"="},replace:!0,transclusion:!0,compile:function(){return{pre:function(c,d){c.$on("commonForm.ready",function(){var e=new b.makeForm(c),f=e.makeHTML();d.append(a(f)(c.$parent))})}}}}}]).directive("inputfield",["$compile","FormMaker",function(a,b){return{restrict:"E",replace:!0,scope:{config:"="},compile:function(){return{pre:function(c,d,e){var f=c.$parent[e.config].fieldDefine,g=new b.makeField(c),h=g.maker.factory(c.$parent[e.config].context,f,c);d.append(a(h)(c.$parent))}}}}}]).directive("select3",["$compile","FormMaker",function(a,b){return{restrict:"E",replace:!0,scope:{config:"="},transclusion:!0,compile:function(){return{pre:function(c,d){var e=new b.select3(c);setTimeout(function(){$(d).after(a(e.makeHTML())(c.$parent)),d.remove()})}}}}}]).directive("bill",["$compile","FormMaker",function(a,b){return{restrict:"E",replace:!0,scope:{config:"="},transclusion:!0,compile:function(){return{pre:function(c,d){if(c.config.isEdit)c.$on("bill.dataLoaded",function(e,f){c.$parent.formMetaData=f;var g=new b.makeBill(c);d.append(a(g.makeHTML())(c.$parent))});else{var e=new b.makeBill(c);d.append(a(e.makeHTML())(c.$parent))}}}}}}]).directive("widgetbox",["$compile","$templateCache","$rootScope",function(a,b,c){return{restrict:"E",scope:{wtitle:"="},replace:!1,transclusion:!0,compile:function(a,b){var d='<div class="widget-box"><div class="widget-header widget-header-flat"><h5>%(title)s</h5></div><div class="widget-body"><div class="widget-main no-padding">%(inner)s</div></div></div>';a.html(sprintf(d,{title:c.i18n.lang.widgetTitles[b.wtitle],inner:a.html()}))}}}]).directive("pageactions",["$compile",function(){return{restrict:"E",templateUrl:"views/common/actions/default.html",replace:!1,transclude:!0}}]),angular.module("erp.common.filters",[]).filter("sprintf",function(){var a=function(a,b,c){return sprintf(a,b,c)};return a}).filter("rmbToBig",function(){return function(a){return a=a||0,rmbToBig(a)}}).filter("propsFilter",function(){return function(a,b){var c=[];return angular.isArray(a)?a.forEach(function(a){for(var d=!1,e=Object.keys(b),f=0;f<e.length;f++){var g=e[f],h=b[g].toLowerCase();if(-1!==a[g].toString().toLowerCase().indexOf(h)){d=!0;break}}d&&c.push(a)}):c=a,c}}).filter("dateFormat",function(){return function(a){if(a){var b=new Date(1e3*parseInt(a)),c=b.getFullYear(),d=b.getMonth()+1,e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();return c+"-"+d+"-"+e+" "+f+":"+g+":"+h}}});var LoginModule=angular.module("login",["erp.config"]);LoginModule.controller("LoginCtl",["$scope","$http","$rootScope","erp.config",function(a,b,c,d){a.error={isError:!1,msg:null},a.error.message=null,a.loginInfo={username:"administrator",password:"123123",remember:!1},a.doLogin=function(){return a.LoginForm.$invalid?!1:(c.sessionHash=c.sessionHash||null,void b.post(d.BSU+"passport/userLogin",a.loginInfo).success(function(b){b.error?(a.error.isError=!0,a.error.msg=b.msg):b.sessionHash&&(window.location.href="app.html?hash="+b.sessionHash)}).error(function(){a.error.isError=!0,a.error.msg="Server Error."}))},a.doKeyDown=function(b){"13"==b.keyCode&&a.doLogin()},a.doRetrivePwd=function(){}}]),LoginModule.run(["$http",function(a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"],a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8",a.defaults.transformRequest=function(a){return angular.isObject(a)&&"[object File]"!==String(a)?jQuery.param(a):a}}]),ERP.factory("UserProfileRes",["$resource","erp.config",function(a,b){return a(b.BSU+"passport/profile.json",null,{update:{method:"PUT"}})}]).factory("UserRes",["$resource","erp.config",function(a,b){return a(b.BSU+"user/:id.json",null,{update:{method:"PUT"}})}]).factory("DepartmentRes",["$resource","erp.config",function(a,b){return a(b.BSU+"passport/department/:id.json",null,{update:{method:"PUT"}})}]).factory("AuthRuleRes",["$resource","erp.config",function(a,b){return a(b.BSU+"passport/authRule/:id.json",null,{update:{method:"PUT"}})}]).factory("AuthGroupRes",["$resource","erp.config",function(a,b){return a(b.BSU+"passport/authGroup/:id.json",null,{update:{method:"PUT"}})}]).factory("AuthGroupRuleRes",["$resource","erp.config",function(a,b){return a(b.BSU+"passport/authGroupRule/:id.json",null,{update:{method:"PUT"},query:{isArray:!1}})}]).factory("WorkflowRes",["$resource","erp.config",function(a,b){return a(b.BSU+"workflow/:id.json",null,{update:{method:"PUT"}})}]).factory("WorkflowNodeRes",["$resource","erp.config",function(a,b){return a(b.BSU+"workflow/nodes/:id.json",null,{update:{method:"PUT"}})}]).factory("WorkflowProcessRes",["$resource","erp.config",function(a,b){return a(b.BSU+"workflow/process/:id.json",{type:"@type"})}]).factory("TypesRes",["$resource","erp.config",function(a,b){return a(b.BSU+"types/:id.json",null,{update:{method:"PUT"}})}]).factory("ConfigRes",["$resource","erp.config",function(a,b){return a(b.BSU+"config/:id.json",null,{update:{method:"PUT"}})}]).factory("DataModelRes",["$resource","erp.config",function(a,b){return a(b.BSU+"home/dataModel/:id.json",null,{update:{method:"PUT"}})}]).factory("DataModelFieldsRes",["$resource","erp.config",function(a,b){return a(b.BSU+"home/dataModelFields/:id.json",null,{update:{method:"PUT"}})}]).factory("DataModelDataRes",["$resource","erp.config",function(a,b){return a(b.BSU+"home/dataModelData/:id.json",null,{update:{method:"PUT"}})}]).factory("GoodsRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/goods/:id.json",null,{update:{method:"PUT"}})}]).factory("ProductTplRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/productTpl/:id.json",null,{update:{method:"PUT"}})}]).factory("ProductTplDetailRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/productTplDetail/:id.json",null,{update:{method:"PUT"}})}]).factory("StockRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stock/:id.json",null,{update:{method:"PUT"}})}]).factory("StockWarningRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stockWarning.json")}]).factory("StockinRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stockin/:id.json",null,{doWorkflow:{method:"GET"},update:{method:"PUT"}})}]).factory("StockTransferRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stockTransfer/:id.json",null,{doWorkflow:{method:"GET"},update:{method:"PUT"}})}]).factory("OutsideRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/outside/:id.json",null,{doWorkflow:{method:"GET"},update:{method:"PUT"}})}]).factory("StockProductListRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stockProductList/:id.json",null,{update:{method:"PUT"}})}]).factory("GoodsCategoryRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/goodsCategory/:id.json",null,{update:{method:"PUT"}})}]).factory("StockoutRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/stockout/:id.json",null,{doWorkflow:{method:"GET"},doPostWorkflow:{method:"POST"},update:{method:"PUT"}})}]).factory("OrdersRes",["$resource","erp.config",function(a,b){return a(b.BSU+"jxc/orders/:id.json",null,{doWorkflow:{method:"GET"},update:{method:"PUT"}})}]).factory("RelCompanyGroupRes",["$resource","erp.config",function(a,b){return a(b.BSU+"crm/relCompanyGroup/:id.json",null,{update:{method:"PUT"}})}]).factory("RelCompanyRes",["$resource","erp.config",function(a,b){return a(b.BSU+"crm/relCompany/:id.json",null,{update:{method:"PUT"}})}]);var ERPBaseConf={BSU:"../erp_server/index.php/",DEBUG:!0,Prefix:"idea-erp",yesNoDataSource:[{id:0,name:"No"},{id:1,name:"Yes"}]};angular.module("erp.config",[]).value("erp.config",ERPBaseConf),angular.module("erp.crm",["erp.crm.services","ngGrid","erp.common.directives"]),angular.module("erp.crm.services",[]).factory("RelCompanyGroupModel",["$rootScope",function(){return{getFieldsStruct:function(){return{id:{primary:!0},name:{},discount:{inputType:"number",max:100,min:1,value:100}}}}}]).factory("RelCompanyModel",["$rootScope","RelCompanyGroupRes",function(a,b){return{getFieldsStruct:function(){return{id:{primary:!0},name:{},group:{field:"Group.name",dataSource:b,inputType:"select"},discount:{},owner:{hideInForm:!0,field:"User.truename"},linkMan:{field:"Linkman[0].contact"},mobile:{field:"Linkman[0].mobile"},telephone:{field:"Linkman[0].tel"},qq:{field:"Linkman[0].qq"}}}}}]),angular.module("erp.doWorkflow",["erp.doWorkflow.service"]).config(["$routeProvider",function(a){a.when("/doWorkflow/Stockout/confirm/:nodeId/:id",{controller:"WorkflowConfirmStockoutCtl",templateUrl:"views/jxc/stockout/confirmStockout.html"})}]).controller("WorkflowConfirmStockoutCtl",["$scope","$routeParams","ComView","StockoutRes","StockoutEditModel","$location",function(a,b,c,d,e,f){a.selectAble=!1,c.displayBill(a,e,d,{id:b.id,queryExtraParams:{includeSource:!0,workflowing:!0}}),a.doSubmit=function(){a.formMetaData.rows=a.formData,d.doPostWorkflow({workflow:!0,node_id:b.nodeId,id:b.id,donext:!0,data:a.formMetaData}).$promise.then(function(){f.url("/JXC/list/tockout")})}}]),angular.module("erp.doWorkflow.service",[]),angular.module("erp.home",["erp.home.services","ngGrid","erp.common.directives"]).config(["$routeProvider",function(a){a.when("/HOME/goTo/url/:url",{controller:"HOMERedirectCtl",templateUrl:"views/common/blank.html"}).when("/HOME/DataModel",{templateUrl:"views/common/grid.html",controller:"DataModelCtl"}).when("/HOME/DataModel/add",{templateUrl:"views/common/edit.html",controller:"DataModelEditCtl"}).when("/HOME/DataModel/edit/id/:id",{templateUrl:"views/common/edit.html",controller:"DataModelEditCtl"}).when("/HOME/DataModel/viewSub/id/:pid",{templateUrl:"views/common/grid.html",controller:"DataModelFieldsCtl"}).when("/HOME/DataModelFields/add/pid/:pid",{templateUrl:"views/common/edit.html",controller:"DataModelFieldsEditCtl"}).when("/HOME/DataModelFields/edit/id/:id/pid/:pid",{templateUrl:"views/common/edit.html",controller:"DataModelFieldsEditCtl"}).when("/HOME/DataModelData/:modelId",{templateUrl:"views/common/grid.html",controller:"DataModelDataCtl"}).when("/HOME/DataModelData/add/:modelId",{templateUrl:"views/common/edit.html",controller:"DataModelDataEditCtl"}).when("/HOME/DataModelData/:modelId/edit/id/:id",{templateUrl:"views/common/edit.html",controller:"DataModelDataEditCtl"}).when("/HOME/viewChild/workflow/pid/:pid",{templateUrl:"views/common/grid.html",controller:"WorkflowNodeCtl"}).when("/HOME/WorkflowNode/add/pid/:pid",{templateUrl:"views/common/edit.html",controller:"WorkflowNodeEditCtl"}).when("/HOME/WorkflowNode/edit/id/:id/pid/:pid",{templateUrl:"views/common/edit.html",controller:"WorkflowNodeEditCtl"}).when("/HOME/Settings/clearCache",{templateUrl:"views/home/clearCache.html",controller:"clearCacheCtl"})}]).controller("HOMERedirectCtl",["$location","$routeParams",function(a,b){a.url(b.url)}]).controller("clearCacheCtl",["$scope","$http","erp.config","ComView",function(a,b,c,d){a.cacheTypes=[null,!0,!0,!0],a.doClearCache=function(){b({method:"POST",url:c.BSU+"HOME/Settings/clearCache",data:{types:a.cacheTypes}}).success(function(){d.alert(a.i18n.lang.messages.cacheCleared,"info")})}}]).controller("WorkflowNodeCtl",["$scope","WorkflowNodeRes","WorkflowNodeModel","ComView","$routeParams",function(a,b,c,d,e){e.group="HOME",e.module="workflowNode";var f=a.$parent.i18n.urlMap.HOME.modules.WorkflowNode.actions;d.makeGridLinkActions(a,f,!1,"/pid/"+e.pid),d.makeGridSelectedActions(a,c,b,"HOME","WorkflowNode"),d.displayGrid(a,c,b,{queryExtraParams:{workflow_id:e.pid},module:"/HOME/WorkflowNode",editExtraParams:"/pid/"+e.pid})}]).controller("WorkflowNodeEditCtl",["$scope","WorkflowNodeModel","WorkflowNodeRes","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/WorkflowNode/add/pid/"+e.pid},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/Workflow/viewSub/id/"+e.pid}],a.selectAble=!1;var f={name:"DataModelEdit",module:"/HOME/WorkflowNode",returnPage:"/HOME/Workflow/viewSub/id/"+e.pid,id:e.id};d.displayForm(a,b,c,f,!0)}]).controller("WorkflowCtl",["$scope","WorkflowRes","WorkflowModel","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/Types/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/Types"}],a.viewSubAble=!0,d.displayGrid(a,c,b)}]).controller("WorkflowEditCtl",["$scope","WorkflowRes","WorkflowModel","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/Types/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/Types"}],a.selectAble=!1;var f={name:"TypesEdit",id:e.id};d.displayForm(a,c,b,f)}]).controller("DataModelCtl",["$scope","DataModelRes","DataModelModel","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModel/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModel"}],a.viewSubAble=!0,d.displayGrid(a,c,b)}]).controller("DataModelEditCtl",["$scope","DataModelModel","DataModelRes","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModel/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModel/"}],a.selectAble=!1;var f={name:"DataModelEdit",id:e.id};d.displayForm(a,b,c,f)}]).controller("DataModelFieldsCtl",["$scope","DataModelFieldsRes","DataModelFieldsModel","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModelFields/add/pid/"+e.pid},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModel/viewSub/id/"+e.pid}],d.displayGrid(a,c,b,{queryExtraParams:{modelId:e.pid},module:"/HOME/DataModelFields",editExtraParams:"/pid/"+e.pid})}]).controller("DataModelFieldsEditCtl",["$scope","DataModelFieldsModel","DataModelFieldsRes","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModelFields/add/pid/"+e.id},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModel/viewSub/id/"+e.pid}],a.selectAble=!1;var f={name:"DataModelEdit",module:"/HOME/DataModelFields",returnPage:"/HOME/DataModel/viewSub/id/"+e.id,id:e.id};d.displayForm(a,b,c,f)}]).controller("DataModelDataCtl",["$scope","DataModelDataRes","DataModelDataModel","ComView","$routeParams",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModelData/add/"+e.modelId},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModelData/"+e.modelId}],d.displayGrid(a,c,b,{module:"/HOME/DataModelData",subModule:e.modelId,queryExtraParams:{modelId:e.modelId}})}]).controller("DataModelDataEditCtl",["$scope","DataModelDataModel","DataModelDataRes","DataModelFieldsRes","ComView","$routeParams",function(a,b,c,d,e,f){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/DataModelData/add/"+f.modelId},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/DataModelData/"+f.modelId}],a.selectAble=!1;var g={name:"DataModelDataEdit",module:"/HOME/DataModelData",returnPage:"/HOME/DataModelData/"+f.modelId,id:f.id,dataLoadedEvent:"foreignDataLoaded"};e.displayForm(a,b,c,g,!0)}]),angular.module("erp.home.services",[]).service("DataModelModel",function(){var a={subAble:!0,addSubAble:!1,subTpl:"/%(group)s/%(action)s/"};return a.getFieldsStruct=function(){return{id:{primary:!0,displayName:"ID"},name:{},type:{}}},a}).service("DataModelFieldsModel",["$rootScope",function(a){var b={};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{id:{primary:!0,displayName:"ID"},display_name:{displayName:b.displayName},field_name:{displayName:b.name},type:{inputType:"select",dataSource:[{id:"text",name:b.inputType.text},{id:"number",name:b.inputType.number},{id:"select",name:b.inputType.select}]}}},b}]).service("DataModelDataModel",["$rootScope","$q","DataModelFieldsRes","$routeParams",function(a,b,c,d){var e={};return e.getFieldsStruct=function(e){var f=a.i18n.lang,g={id:{primary:!0,displayName:"ID"},data:{},model_name:{displayName:f.modelName,hideInForm:!0},display_name:{displayName:f.displayName,hideInForm:!0},field_name:{displayName:f.name,hideInForm:!0},field_id:{displayName:f.field,listable:!1,inputType:"select",nameField:"display_name"}};if(e)return g;var h=b.defer();return c.query({modelId:d.modelId},function(a){g.field_id.dataSource=a,h.resolve(g)}),h.promise},e}]).service("TypesModel",["$rootScope",function(a){var b={};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{id:{primary:!0},type:{inputType:"select",dataSource:[{id:"purchase",name:b.types.purchase},{id:"sale",name:b.types.sale},{id:"returns",name:b.types.returns},{id:"shipment",name:b.types.shipment},{id:"freight",name:b.types.freight},{id:"receive",name:b.types.receive},{id:"pay",name:b.types.pay},{id:"voucher",name:b.types.voucher}]},alias:{},name:{},listorder:{inputType:"number",value:99},status:{inputType:"checkbox"}}},b}]).service("ConfigModel",["$rootScope",function(){return{getFieldsStruct:function(){return{id:{primary:!0},alias:{},name:{},value:{inputType:"textarea"},description:{inputType:"textarea",required:!1}}}}}]).service("WorkflowModel",["$rootScope",function(a){return{subAble:!0,addSubAble:!1,getFieldsStruct:function(){return{id:{primary:!0},alias:{},name:{},workflow_file:{displayName:a.i18n.lang.workflowAssitFile},memo:{}}}}}]).service("WorkflowNodeModel",["$rootScope","WorkflowNodeRes","$routeParams","$q",function(a,b,c,d){var e={extraParams:{pid:c.pid},listUrl:sprintf("/HOME/viewChild"),getFieldsStruct:function(e){var f={id:{primary:!0},name:{},type:{},execute_file:{listable:!1},listorder:{value:99},prev_node_id:{inputType:"select",required:!1},next_node_id:{inputType:"select",required:!1},executor:{listable:!1,required:!1},cond:{listable:!1,required:!1},"default":{listable:!1,inputType:"select",dataSource:[{id:1,name:a.i18n.lang.yes},{id:-1,name:a.i18n.lang.no}]},remind:{listable:!1},status_text:{},memo:{required:!1}};if(e)return f;var g=d.defer();return b.query({workflow_id:c.pid},function(a){f.prev_node_id.dataSource=a,f.next_node_id.dataSource=a,g.resolve(f)}),g.promise}};return e}]),angular.module("erp.jxc",["erp.jxc.services","ngGrid","erp.common.directives"]).config(["$routeProvider",function(a){a.when("/JXC/addBill/stockin",{templateUrl:"views/jxc/stockin/edit.html",controller:"JXCStockinEditCtl"}).when("/JXC/editBill/stockin/id/:id",{templateUrl:"views/jxc/stockin/edit.html",controller:"JXCStockinEditCtl"}).when("/JXC/export/stockProductList",{templateUrl:"views/jxc/stockProductList/export.html",controller:"StockProductsExportCtl"}).when("/JXC/Stock/warning",{templateUrl:"views/common/grid.html",controller:"StockWarningCtl"}).when("/JXC/ProductTpl",{templateUrl:"views/common/grid.html",controller:"ProductTplCtl"}).when("/JXC/ProductTpl/add",{templateUrl:"views/common/edit.html",controller:"ProductTplEditCtl"}).when("/JXC/edit/productTpl/id/:id",{templateUrl:"views/jxc/productTpl/edit.html",controller:"ProductTplEditCtl"}).when("/JXC/ProductTpl/viewSub/id/:pid",{templateUrl:"views/jxc/productTpl/edit.html",controller:"ProductTplDetailCtl"}).when("/JXC/addBill/orders",{templateUrl:"views/jxc/orders/edit.html",controller:"JXCOrdersEditCtl"}).when("/JXC/Orders/edit/id/:id",{templateUrl:"views/jxc/orders/edit.html",controller:"JXCOrdersEditCtl"})}]).controller("StockoutCtl",["$scope","StockoutRes","StockoutModel","ComView",function(a,b,c,d){d.makeDefaultPageAction(a,"JXC/Stockout"),d.displayGrid(a,c,b),a.workflowAble=!0,a.workflowAlias="stockout",a.$parent.assignWorkflowNodes(a),a.doWorkflow=function(c,d){return a.$parent.doWorkflow(c,d,a.gridSelected,b)},a.workflowActionDisabled=function(b){return a.$parent.workflowActionDisabled(b,a.gridSelected)},a.workflowDisabled=!1}]).controller("JXCOrdersCtl",["$scope","OrdersRes","OrdersModel","$location","ComView",function(a,b,c,d,e){e.makeDefaultPageAction(a,"JXC/Orders"),e.displayGrid(a,c,b),a.workflowAble=!0,a.workflowAlias="order",a.$parent.assignWorkflowNodes(a),a.doWorkflow=function(c,d){return a.$parent.doWorkflow(c,d,a.gridSelected,b)},a.workflowActionDisabled=function(b){return a.$parent.workflowActionDisabled(b,a.gridSelected)},a.workflowDisabled=!1}]).controller("JXCOrdersEditCtl",["$scope","OrdersRes","GoodsRes","OrdersEditModel","ComView","RelCompanyRes","$routeParams","TypesRes",function(a,b,c,d,e,f,g,h){e.makeDefaultPageAction(a,"JXC/Orders"),a.workflowAble=!0,a.selectAble=!1,a.showWeeks=!0,a.formMetaData={inputTime:new Date,total_amount_real:0},e.displayBill(a,d,b,{id:g.id}),a.customerSelectOpts={context:{field:"customer_id"},fieldDefine:{inputType:"select3","ng-model":"formMetaData.customer_id",dataSource:f}},a.typeSelectOpts={context:{field:"sale_type"},fieldDefine:{inputType:"select","ng-model":"formMetaData.sale_type",dataSource:h,queryParams:{type:"sale"}}},a.$watch("formMetaData.customer_id",function(){a.formMetaData.customer_id&&f.get({id:a.formMetaData.customer_id},function(b){b.discount=parseInt(b.discount),a.formMetaData.customerInfo={id:b.id,name:b.name,discount:parseInt(b.discount)}})}),a.$watch("formMetaData.total_amount",function(){a.formMetaData.total_amount_real=a.formMetaData.total_amount});var i=function(b,c,d,e){e=void 0==e||100,a.formData[b].amount=Number(parseFloat(d*c*e/100).toFixed(2))};a.onNumberBlur=function(b){var d=getInputContext(b.target);if(a.formData[d.trid]&&a.formData[d.trid].goods_id){var e=a.formData[d.trid].goods_id.split("_");c.get({id:e[1]}).$promise.then(function(b){a.formData[d.trid].unit_price=Number(b.price)})}a.formMetaData.customerInfo&&(a.formData[d.trid].discount=a.formMetaData.customerInfo.discount),i(d.trid,a.formData[d.trid].unit_price,a.formData[d.trid].num,a.formData[d.trid].discount)},a.onUnitPriceBlur=function(b){var c=getInputContext(b.target);i(c.trid,a.formData[c.trid].unit_price,a.formData[c.trid].num,a.formData[c.trid].discount)},a.maxDate=new Date,a.formats=["yyyy-MM-dd","yyyy-mm-dd","shortDate"],a.format=a.formats[0]}]).controller("ProductTplCtl",["$scope","ProductTplRes","ProductTplModel","ComView",function(a,b,c,d){d.makeDefaultPageAction(a,"JXC/ProductTpl"),a.viewSubAble=!0,d.displayGrid(a,c,b)}]).controller("ProductTplEditCtl",["$scope","ProductTplRes","ProductTplEditModel","ComView","$routeParams",function(a,b,c,d,e){d.makeDefaultPageAction(a,"JXC/productTpl",["addBill","list"]),a.selectAble=!1,d.displayForm(a,c,b,{id:e.id}),a.formMetaData={}}]).controller("ProductTplDetailCtl",["$scope","ProductTplDetailRes","ProductTplDetailModel","ComView","$routeParams",function(a,b,c,d,e){a.formMetaData={},a.selectAble=!1,e.id=e.pid,d.displayBill(a,c,b,{id:e.pid,module:"/JXC/ProductTplDetail",editExtraParams:"/pid/"+e.pid})}]).controller("JXCStockinEditCtl",["$scope","StockinRes","StockinEditModel","ComView","$routeParams",function(a,b,c,d,e){d.makeDefaultPageAction(a,"JXC/Stockin"),a.workflowAble=!0,a.selectAble=!1,a.showWeeks=!0,d.displayBill(a,c,b,{id:e.id}),a.formMetaData={},a.formMetaData.inputTime=new Date,a.maxDate=new Date,a.formats=["yyyy-MM-dd","yyyy-mm-dd","shortDate"],a.format=a.formats[0]}]).controller("StockProductsExportCtl",["$scope","StockProductExportModel","ComView","$http","erp.config",function(a,b,c,d,e){a.pageActions=[{label:a.i18n.lang.actions.list,"class":"primary",href:"/JXC/StockProductList"},{label:a.i18n.lang.actions.export,"class":"success",href:"/JXC/StockProductList/Export"}],a.selectAble=!1,c.displayForm(a,b,null,{name:"export"},!0),a.doSubmit=function(){var b=e.BSU+"JXC/StockProductList/Export";a.exportData.stock&&(b+="/stock/"+a.exportData.stock.join("_")),b+="/category/"+a.exportData.category.join("_"),b+="/warningonly/"+a.exportData.stockWarningOnly,window.open(b)}}]),angular.module("erp.jxc.services",[]).service("GoodsModel",["$rootScope","GoodsCategoryRes","$q",function(a,b,c){var d={};return d.getFieldsStruct=function(d){var e=a.i18n.lang,f={id:{primary:!0},factory_code:{},name:{},pinyin:{displayName:e.firstChar,required:!1},measure:{},price:{inputType:"number",cellFilter:"currency:'￥'",value:0},cost:{inputType:"number",cellFilter:"currency:'￥'",value:0},goods_category_id:{displayName:e.category,inputType:"select",valueField:"id",nameField:"prefix_name",listable:!1},category_name:{displayName:e.category,inputType:!1,hideInForm:!0},store_min:{inputType:"number",value:0},store_max:{inputType:"number",value:0}};if(d)return f;var g=c.defer();return b.query(function(a){f.goods_category_id.dataSource=a,g.resolve(f)}),g.promise},d}]).service("GoodsCategoryModel",["$rootScope","$q","DataModelRes",function(a,b,c){var d={subAble:!0,viewSubAble:!1};return d.getFieldsStruct=function(d){var e=a.i18n.lang,f={id:{primary:!0},name:{displayName:e.category,listable:!1},prefix_name:{hideInForm:!0,displayName:e.category},bind_model_name:{displayName:e.bindDataModel,hideInForm:!0},pinyin:{displayName:e.firstChar,required:!1},bind_model:{displayName:e.bindDataModel,inputType:"select",listable:!1},listorder:{inputType:"number",value:99}};if(d)return f;var g=b.defer();return c.query(function(a){f.bind_model.dataSource=a,g.resolve(f)}),g.promise},d}]).service("StockModel",["$rootScope","UserRes","$q",function(a,b,c){var d={};return d.getFieldsStruct=function(d){var e=c.defer(),f={id:{primary:!0,displayName:"ID"},name:{},managers_name:{displayName:a.i18n.lang.stockManager,hideInForm:!0},managers:{displayName:a.i18n.lang.stockManager,nameField:"truename",valueField:"id",inputType:"select",multiple:"multiple",remoteDataField:"managers",listable:!1},total_num:{displayName:a.i18n.lang.total,hideInForm:!0}};return d?f:(b.query().$promise.then(function(a){f.managers.dataSource=a,e.resolve(f)}),e.promise)},d}]).service("StockProductListModel",["$rootScope","$q","DataModelRes",function(a){var b={deleteAble:!1,exportAble:!0};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{factory_code_all:{hideInForm:!0},goods_name:{inputType:"static"},standard:{inputType:"static"},version:{inputType:"static"},unit_price:{cellFilter:"currency:'￥'",inputType:"number"},cost:{cellFilter:"currency:'￥'",inputType:"number"},category_name:{hideInForm:!0,displayName:b.category},stock_name:{inputType:"static",displayName:b.stock},num:{hideInForm:!0,displayName:b.storeNum},measure:{hideInForm:!0},store_min:{hideInForm:!0},store_max:{hideInForm:!0}}},b}]).service("StockProductEditModel",["$rootScope",function(){return{getFieldsStruct:function(){return{id:{primary:!0},unit_price:{inputType:"number"},cost:{inputType:"number"}}}}}]).service("StockProductExportModel",["$rootScope","StockRes","GoodsCategoryRes","$q",function(a,b,c,d){var e={getFieldsStruct:function(){var e=a.i18n.lang,f={stock:{inputType:"select",required:!1,multiple:!0,dataSource:b},category:{inputType:"select",multiple:!0,nameField:"prefix_name"},stockWarningOnly:{inputType:"select",dataSource:[{id:1,name:e.yes},{id:-1,name:e.no}],required:!1}},g=d.defer();return c.query(function(a){f.category.dataSource=a,g.resolve(f)
}),g.promise}};return e}]).service("StockTransferModel",["$rootScope",function(a){var b={isBill:!0,workflowAlias:"stocktransfer"};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{bill_id:{displayName:b.billId},subject:{},total_num:{displayName:b.totalNum},dateline:{cellFilter:"dateFormat"},status_text:{displayName:b.status,field:"processes.status_text"},sponsor:{},stock_manager:{displayName:b.stockManager}}},b}]).service("StockinModel",["$rootScope",function(a){var b={isBill:!0,workflowAlias:"stockin"};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{bill_id:{displayName:b.billId},subject:{},total_num:{displayName:b.totalNum},dateline:{cellFilter:"dateFormat"},status_text:{displayName:b.status,field:"processes.status_text"},sponsor:{},stock_manager:{displayName:b.stockManager}}},b}]).service("StockinEditModel",["$rootScope","GoodsRes","StockRes","DataModelDataRes",function(a,b,c,d){var e={};return e.getFieldsStruct=function(){var e=a.i18n.lang,f={id:{primary:!0,billAble:!1},goods_id:{displayName:e.goods,labelField:!0,inputType:"select3",dataSource:b,valueField:"combineId",nameField:"combineLabel",listAble:!1,width:300},standard:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"standard"}},version:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"version"}},stock:{editAbleRequire:["goods_id","standard","version"],inputType:"select3",dataSource:c,autoQuery:!0,autoHide:!0},store_num:{displayName:e.storeNum,editAble:!1,min:-9999},num:{inputType:"number",totalAble:!0},memo:{}};return f},e}]).service("OrdersModel",["$rootScope",function(a){var b={isBill:!0,workflowAlias:"order"};return b.getFieldsStruct=function(){var b=a.i18n.lang;return{bill_id:{displayName:b.billId},sale_type_label:{displayName:b.type,hideInForm:!0},sale_type:{displayName:b.type,listable:!1},customer:{hideInForm:!0},customer_id:{listable:!1},total_num:{displayName:b.totalNum},total_amount_real:{},dateline:{cellFilter:"dateFormat"},status_text:{displayName:b.status,field:"processes.status_text"},sponsor:{}}},b}]).service("OrdersEditModel",["$rootScope","GoodsRes","StockRes","DataModelDataRes",function(a,b,c,d){var e={};return e.getFieldsStruct=function(){var c=a.i18n.lang,e={id:{primary:!0,billAble:!1},goods_id:{displayName:c.goods,labelField:!0,inputType:"select3",dataSource:b,valueField:"combineId",nameField:"combineLabel",listAble:!1,width:300},standard:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"standard"}},version:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"version"}},num:{inputType:"number",totalAble:!0,"ui-event":"{blur: 'afterNumBlur($event)'}"},discount:{inputType:"number"},unit_price:{inputType:"number","ui-event":"{blur: 'afterUnitPriceBlur($event)'}",cellFilter:"currency:'￥'"},amount:{inputType:"number",cellFilter:"currency:'￥'",totalAble:!0},memo:{}};return e},e}]).service("StockWarningModel",["$rootScope",function(a){return{getFieldsStruct:function(){return{factory_code_all:{displayName:a.i18n.lang.factoryCodeAll},goods_name:{displayName:a.i18n.lang.name},standard:{},version:{},measure:{},category_name:{displayName:a.i18n.lang.category},stock_name:{displayName:a.i18n.lang.stock},num:{},store_min:{},store_max:{}}}}}]).service("OutsideModel",["$rootScope","GoodsRes","DataModelDataRes","StockRes",function(a,b,c,d){var e={};e.getFieldsStruct=function(){var e=a.i18n.lang,f={id:{primary:!0,billAble:!1},goods_id:{displayName:e.goods,inputType:"select3",dataSource:b,valueField:"combineId",nameField:"combineLabel",listAble:!1,width:300},standard:{nameField:"data",valueField:"id",inputType:"select3",editAbleRequire:"goods_id",dataSource:c,queryWithExistsData:["goods_id"],queryParams:{fieldAlias:"standard"}},version:{nameField:"data",valueField:"id",inputType:"select3",editAbleRequire:"goods_id",dataSource:c,queryWithExistsData:["goods_id"],queryParams:{fieldAlias:"version"}},stock:{editAbleRequire:["goods_id","standard","version"],inputType:"select3",dataSource:d},store_num:{displayName:e.storeNum,editAble:!1,min:-9999},num:{inputType:"number",totalAble:!0},memo:{}};return f}}]).service("ProductTplModel",["$rootScope","GoodsRes","DataModelDataRes",function(a,b,c){return{getFieldsStruct:function(){var d={id:{primary:!0},factory_code_all:{hideInForm:!0},goods_name:{hideInForm:!0},goods_id:{displayName:a.i18n.lang.goods,listable:!1,inputType:"select3",dataSource:b},measure:{hideInForm:!0},standard:{field:"standard_label",nameField:"data",valueField:"id",inputType:"select3",editAbleRequire:"goods_id",dataSource:c,queryWithExistsData:["goods_id"],autoQuery:!0,queryParams:{fieldAlias:"standard"}},version:{field:"version_label",nameField:"data",valueField:"id",inputType:"select3",editAbleRequire:"goods_id",dataSource:c,queryWithExistsData:["goods_id"],autoQuery:!0,queryParams:{fieldAlias:"version"}}};return d}}}]).service("ProductTplEditModel",["$rootScope","StockRes","GoodsRes",function(a,b,c){return{getFieldsStruct:function(){return{factory_code_all:{hideInForm:!0},goods_name:{hideInForm:!0},goods_id:{displayName:a.i18n.lang.goods,listable:!1,dataSource:c},num:{},stock_id:{displayName:a.i18n.lang.stock,inputType:"select",dataSource:b}}}}}]).service("ProductTplDetailModel",["$rootScope","StockRes","GoodsRes","DataModelDataRes",function(a,b,c,d){return{getFieldsStruct:function(){var e=a.i18n.lang;return{goods_id:{displayName:e.goods,labelField:!0,inputType:"select3",dataSource:c,valueField:"combineId",nameField:"combineLabel",listAble:!1,width:300},standard:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"standard"}},version:{nameField:"data",valueField:"id",labelField:!0,inputType:"select3",editAbleRequire:"goods_id",dataSource:d,queryWithExistsData:["goods_id"],autoQuery:!0,autoReset:!0,autoHide:!0,queryParams:{fieldAlias:"version"}},stock:{editAbleRequire:["goods_id","standard","version"],inputType:"select3",dataSource:b,autoQuery:!0,autoHide:!0},num:{inputType:"number",totalAble:!0},memo:{}}}}}]).service("StockoutModel",["$rootScope",function(a){return{isBill:!0,workflowAlias:"stockout",getFieldsStruct:function(){return{bill_id:{},source_model:{},total_num:{},stock_manager:{},dateline:{cellFilter:"dateFormat"},status_text:{displayName:a.i18n.lang.status,field:"processes.status_text"},outtime:{displayName:a.i18n.lang.outStockTime,cellFilter:"dateFormat"}}}}}]).service("StockoutEditModel",["$rootScope","GoodsRes","StockRes","DataModelDataRes",function(a,b,c){var d={isBill:!0};return d.getFieldsStruct=function(){var b=a.i18n.lang,d={id:{primary:!0,billAble:!1},factory_code_all:{editAble:!1},goods_id:{displayName:b.goods,editAble:!1},standard:{editAble:!1},version:{editAble:!1},stock:{editAbleRequire:["goods_id","standard","version"],inputType:"select3",dataSource:c,autoQuery:!0},store_num:{displayName:b.storeNum,editAble:!1},num:{inputType:"number",totalAble:!0},memo:{editAble:!1}};return d},d}]),function(){angular.module("erp.commonView",["erp.formMaker","mgcrea.ngStrap"]).config(["$routeProvider",function(a){a.when("/:group/list/:module",{templateUrl:"views/common/grid.html",controller:"ComViewGridCtl"}).when("/:group/list/:module/:extra*",{templateUrl:"views/common/grid.html",controller:"ComViewGridCtl"}).when("/:group/add/:module",{templateUrl:"views/common/edit.html",controller:"ComViewEditCtl"}).when("/:group/add/:module/:extra*",{templateUrl:"views/common/edit.html",controller:"ComViewEditCtl"}).when("/:group/edit/:module/id/:id",{templateUrl:"views/common/edit.html",controller:"ComViewEditCtl"}).when("/:group/edit/:module/id/:id/:extra*",{templateUrl:"views/common/edit.html",controller:"ComViewEditCtl"}).when("/:group/addChild/:module/pid/:pid",{templateUrl:"views/common/edit.html",controller:"ComViewEditCtl"})}]).value("ComViewConfig",{actionClasses:{add:"primary",list:"default","export":"success"}}).controller("ComViewGridCtl",["$rootScope","$scope","ComView","$routeParams","$injector","ComViewConfig","$location",function(a,b,c,d,e){var f,g,h,i,j;g=d.group,f=d.module,h=e.get(f.ucfirst()+"Res"),i=e.get(f.ucfirst()+"Model"),j=a.i18n.urlMap[g].modules[f.ucfirst()].actions,c.makeGridLinkActions(b,j,i.isBill),c.makeGridSelectedActions(b,i,h,g,f);var k={};d.extra&&(k.queryExtraParams=parseParams(d.extra)),c.displayGrid(b,i,h,k)}]).controller("ComViewEditCtl",["$rootScope","$scope","ComView","$routeParams","$injector","ComViewConfig",function(a,b,c,d,e){var f,g,h,i,j;g=d.group,f=d.module,h=e.get(f.ucfirst()+"Res"),i=e.get(f.ucfirst()+"Model"),j=a.i18n.urlMap[g].modules[f.ucfirst()].actions,c.makeGridLinkActions(b,j,i.isBill,d.extra),b.selectAble=!1,c.displayForm(b,i,h,{id:d.id})}]).service("ComView",["$location","$rootScope","$routeParams","$q","$alert","$aside","WorkflowProcessRes","ComViewConfig","$injector",function(a,b,c,d,e,f,g,h,i){var j={};return j.alert=function(a,b,c,d){b=b||"warning",c=c||b.ucfirst()+":";var f=e({title:c,content:a,placement:"top-right",type:b,show:!0,container:"#alerts-container"});d!==!1&&setTimeout(function(){f.hide()},5e3)},j.aside=function(a,b,c){c=c||"views/common/aside.html",f({title:a,content:b,template:c})},j.displayForm=function(b,d,e,f,g){var h={name:null,id:null,dataLoadedEvent:null,dataObject:null,returnPage:sprintf("/%(group)s/list/%(module)s",{group:c.group,module:c.module})};f=$.extend(h,f),f.dataObject=f.name+"Data";var i=function(a){b.config={fieldsDefine:a,name:f.name},f.id&&e.get({id:f.id}).$promise.then(function(a){b[f.dataObject]=dataFormat(b.config.fieldsDefine,a)}),setTimeout(function(){b.$broadcast("commonForm.ready")})};if("object"==typeof d&&"getFieldsStruct"in d&&"function"==typeof d.getFieldsStruct){var k=d,l=k.getFieldsStruct();g||"function"==typeof l.then?l.then(function(a){i(a)},function(a){j.alert(a)}):i(l)}else i();b.doSubmit=f.doSubmit?f.doSubmit:function(){if(!b[f.name].$valid)return void j.alert(b.i18n.lang.messages.fillTheForm,"danger");if(f.id){var d={};for(var g in c)d[g]=c[g];d.id=f.id,e.update(d,b[f.dataObject],function(b){b.error?j.alert(b.msg):a.url(f.returnPage)})}else{for(var g in c)b[f.dataObject][g]=c[g];var d={};for(var g in c)d[g]=c[g];var h=$.extend(d,b[f.dataObject]);h=$.extend(h,b[f.dataObject]),e.save(h,function(a){a.error&&j.alert(a.msg)})}}},j.displayGrid=function(c,d,e,f){c.totalServerItems=0,c.gridSelected=[];var g=f?f:{};d=d?d:[];var h=[];if("object"==typeof d&&"getFieldsStruct"in d&&"function"==typeof d.getFieldsStruct){var i=d;d=i.getFieldsStruct(!0)}for(var j in d)d[j].field||(d[j].field=j),d[j].displayName||(d[j].displayName=b.i18n.lang[j]),h.push(d[j]);var k;for(var l in h)k=h[l],0==k.listable&&h.splice(l,1);var m={pageSizes:[15,30,50],pageSize:15,currentPage:1},n={filterText:"",useExternalFilter:!0},o={data:"itemsList",enablePaging:!0,showFooter:!0,showFilter:!0,showColumnMenu:!0,showSelectionCheckbox:!0,rowHeight:40,multiSelect:!0,headerRowHeight:40,enableColumnResize:!0,selectedItems:c.gridSelected,totalServerItems:"totalServerItems",i18n:"zh-cn",module:a.$$url.split("/").splice(0,3).join("/"),subModule:"",queryExtraParams:{},editExtraParams:""},f=$.extend(o,g);f.subModule=f.subModule?"/"+f.subModule:"",c.doAddChild=f.doAddChild?f.doAddChild:function(){c.gridSelected.length&&a.url(f.module+f.subModule+"/add/pid/"+c.gridSelected[0].id)},c.doView=f.doView?f.doView:function(){c.gridSelected.length&&a.url(f.module+f.subModule+"/view/id/"+c.gridSelected[0].id)},c.doViewSub=f.doViewSub?f.doViewSub:function(){c.gridSelected.length&&a.url(f.module+f.subModule+"/viewSub/id/"+c.gridSelected[0].id)},c.doViewDataModel=f.doViewDataModel?f.doViewDataModel:function(){a.url("/HOME/DataModelData/"+c.gridSelected[0].bind_model)},c.doEditSelected=f.doEditSeleted?f.doEditSelected:function(){c.gridSelected.length&&a.url(f.module+f.subModule+"/edit/id/"+c.gridSelected[0].id+f.editExtraParams)},c.doDeleteSelected=f.doDeleleSelected?f.doDeleleSelected:function(){if(!confirm(sprintf(c.i18n.lang.confirm_delete,c.gridSelected.length)))return!1;for(var a=[],b=0;b<c.gridSelected.length;b++)a.push(c.gridSelected[b].id);e.delete({id:a.join(",")},function(){c.$broadcast("gridData.changed")}),c.gridOptions.selectedItems=[],c.gridSelected=[]},c.doExport=function(){},f.columnDefs=h;var p=function(a,b,d){var e=a.slice((b-1)*d,b*d);c.itemsList=e,c.totalServerItems=a.length,c.$$phase||c.$apply()},q=function(a,b,c){setTimeout(function(){var d;if(c){var g=c.toLowerCase();e.query(f.queryExtraParams,function(c){d=c.filter(function(a){return-1!=JSON.stringify(a).toLowerCase().indexOf(g)}),p(d,b,a)})}else e.query(f.queryExtraParams,function(c){p(c,b,a)})},100)};"pagingOptions"in f||(c.pagingOptions=f.pagingOptions=m),"filterOptions"in f||(c.filterOptions=f.filterOptions=n),q(m.pageSize,m.currentPage),c.$watch("pagingOptions",function(a,b){a!==b&&q(m.pageSize,m.currentPage,n.filterText)},!0),c.$watch("filterOptions",function(a,b){a!==b&&q(m.pageSize,m.currentPage,n.filterText)},!0),c.$on("gridData.changed",function(){var b="/HOME/goTo/url/"+encodeURI(encodeURIComponent(a.$$url));a.url(b)}),c.gridOptions=f},j.displayBill=function(d,e,f,g){var h={dataName:"formData",queryExtraParams:{}};if("object"==typeof e&&"getFieldsStruct"in e&&"function"==typeof e.getFieldsStruct){var i=e;e=i.getFieldsStruct(!0)}for(var j in e)e[j].field||(e[j].field=j),e[j].displayName||(e[j].displayName=b.i18n.lang[j]);if(g=$.extend(h,g),g.fieldsDefine=e,c.id){g.isEdit=!0;var k=$.extend(h.queryExtraParams,{id:c.id,includeRows:!0});f.get(k).$promise.then(function(a){d.$broadcast("bill.dataLoaded",a)})}d.config=g,d.doSubmit=g.doSubmit?g.doSubmit:function(){var b=$.extend(d.formMetaData,{rows:d[g.dataName]}),e={};for(var h in c)e[h]=c[h];g.id?(e.id=g.id,f.update(e,b)):f.save(e,b),a.url(g.returnPage)}},j.makeGridSelectedActions=function(d,e,f,h,k){d.selectedActions=[];var l="";if(c.extra){var m=parseParams(c.extra);angular.forEach(m,function(a,b){l+=sprintf("/%s/%s",b,a)})}if((void 0===e.editAble||e.editAble)&&d.selectedActions.push({label:b.i18n.lang.actions.edit,action:function(){if(!(d.gridSelected.length>1)){var b="edit";e.isBill&&(b="editBill"),a.url(sprintf("/%(group)s/%(action)s/%(module)s/id/%(id)s",{group:h,action:b,module:k,id:d.gridSelected[0].id})+l)}},"class":"default",multi:!1}),e.subAble&&(!1!==e.addSubAble&&d.selectedActions.push({label:b.i18n.lang.actions.addChild,"class":"primary",multi:!1,action:function(){a.url(sprintf("/%(group)s/addChild/%(module)s/pid/%(id)d",{group:h,module:k,id:Number(d.gridSelected[0].id)})+l)}}),!1!==e.viewSubAble&&d.selectedActions.push({label:b.i18n.lang.actions.viewChild,"class":"primary",multi:!1,action:function(){a.url(sprintf("/%(group)s/viewChild/%(module)s/pid/%(id)d",{group:h,module:k,id:Number(d.gridSelected[0].id)})+l)}})),e.workflowAlias){d.workflowAble=!0,d.workflowAlias=e.workflowAlias;var n=i.get("WorkflowNodeRes");n.query({workflow_alias:e.workflowAlias,only_active:!0}).$promise.then(function(a){d.workflowActionList=a}),d.doWorkflow=function(b,c){var e=d.gridSelected||[];if(!e.length||$(b.target).parent().hasClass("disabled"))return!1;for(var g=0;g<e.length;g++)f.doWorkflow({workflow:!0,node_id:c,id:e[g].id}).$promise.then(function(b){if(b.type)switch(b.type){case"redirect":return void a.url(b.location)}});d.$broadcast("gridData.changed")},d.workflowActionDisabled=function(a){var b=d.gridSelected||[];if(b.length>1)return!0;if(!b.length)return!0;for(var c=!0,e=0;e<b.length;e++){var f=b[e];if(!f.processes){c=!0;break}angular.forEach(f.processes.nextNodes,function(b){return b.id===a?void(c=!1):void 0})}return c},d.doViewWorkflowProcesses=function(){return d.gridSelected.length?void g.query({id:d.gridSelected[0].id,workflowAlias:d.workflowAlias}).$promise.then(function(a){j.aside({bill_id:d.gridSelected[0].bill_id,title:d.gridSelected[0].subject,subTitle:d.gridSelected[0].dateline_lang},a,"views/common/workflowProcess.html")}):!1}}(void 0===e.deleteAble||e.deleteAble)&&d.selectedActions.push({label:b.i18n.lang.actions.delete,action:function(){var a=[];return angular.forEach(d.gridSelected,function(b){a.push(b.id)}),confirm(sprintf(b.i18n.lang.confirm_delete,d.gridSelected.length))?(f.delete({id:a.join()},function(){d.$broadcast("gridData.changed")}),d.gridOptions.selectedItems=[],void(d.gridSelected=[])):!1},"class":"danger",multi:!0})},j.makeGridLinkActions=function(a,d,e,f){f=f?"/"+f:"";var g=["add","list","export","print"];a.pageActions=[],angular.forEach(d,function(d,i){if(!(g.indexOf(i)<0)){var j=i;e&&"add"===i&&(j="addBill"),a.pageActions.push({label:b.i18n.lang.actions[i],"class":h.actionClasses[i],href:sprintf("/%(group)s/%(action)s/%(module)s",{group:c.group,action:j,module:c.module})+f})}})},j.makeDefaultPageAction=function(a,b,c){c=c||["add","list"];var d=["success","primary"];a.pageActions=[];for(var e=0;e<c.length;e++)a.pageActions.push({label:a.i18n.lang.actions[c[e]],"class":d[e],href:b.replace("/",sprintf("/%s/",c[e]))})},j}])}(window.angular),function(){"use struct";angular.module("erp.formMaker",[]).service("FormMaker",["$compile","$q","$parse","StockProductListRes",function($compile,$q,$parse,StockProductListRes){var service={};return service.makeField=function(a,b){var c={};this.scope=a,this.opts=$.extend(c,b),this.templates={"fields/text":'<input type="text" %s />',"fields/number":'<input type="number" %s />',"fields/select":'<select %(attr)s ng-options="%(key)s.value as %(key)s.name for %(key)s in %(data)s" search_contains="true" ><option><option></select>',"fields/static":'<span ng-bind="%s"></span>',"fields/email":'<input type="number" %s />',"fields/textarea":"<textarea %s>%s</textarea>","fields/password":'<input type="password" %s />',"fields/select2":'<ui-select ng-model="%(model)s" class="editAble" %(event)s theme="selectize" reset-search-input="false" %(attrs)s><match ng-bind-html="$select.selected.label"></match><choices refresh="%(method)s_refresh($select.search)" refresh-delay="0" repeat="%(data)s in %(method)s | filter: $select.search"><div ng-bind-html="%(data)s.label"></div></choices></ui-select>',"fields/typeahead":'<input type="text" typeahead-on-select="showselected(this)" typeahead-editable="false" typeahead-min-length="0" ng-options="%(key)s.label as %(key)s.label for %(key)s in %(data)s($viewValue)" %(attr)s data-html="true" bs-typeahead />'},this.maker=new service.fieldsMakerFactory(this,this.opts)},service.fieldsMakerFactory=function(a,b){this.$parent=a;var c={multi:!1,compile:!1};this.opts=$.extend(c,b),this.opts.disabledAttrs=["dataSource"]},service.fieldsMakerFactory.prototype={factory:function(a,b,c,d){var e="_"+(b.inputType?b.inputType:"text");d&&angular.forEach(d,function(a,c){b[c]=a+"($event)"}),a.text&&(b.value=a.text),void 0!==a.trid&&this.opts.multi&&(b["data-row-index"]=a.trid),b.displayName||(b.displayName=this.$parent.scope.$parent.i18n.lang[a.field]);var f=!1;return e in this&&(f=this[e](a.field,b,c)),f&&this.opts.compile&&(f=$compile(f)(c)),f},_attr:function(a,b){var c,d,e=[];this.opts.multi||(b.id="id_"+a,b.name=a);for(c in b)this.opts.disabledAttrs.indexOf(c)>=0||(d=b[c],e.push(sprintf('%s="%s"',c,d)));return e.join(" ")},_text:function(a,b){return sprintf(this.$parent.templates["fields/text"],this._attr(a,b))},_number:function(a,b){return sprintf(this.$parent.templates["fields/number"],this._attr(a,b))},_password:function(a,b){return delete b.value,sprintf(this.$parent.templates["fields/password"],this._attr(a,b))},_checkbox:function(){},_static:function(a,b){return""},_textarea:function(a,b){var c=b.value;return delete b.value,sprintf(this.$parent.templates["fields/textarea"],this._attr(a,b),c)},_select:function(a,b,c){var d=b.valueField||"id",e=b.nameField||"name",f=[],g=this;if(b.chosen="chosen",b.remoteDataField=b.remoteDataField||a,b["data-placeholder"]=c.$parent.i18n.lang.messages.chosen_select_text,b["no-results-text"]=c.$parent.i18n.lang.messages.chosen_no_result_text,b.dataSource instanceof Array){for(var h in b.dataSource)h&&b.dataSource[h][d]&&f.push({value:b.dataSource[h][d],name:b.dataSource[h][e]});c.$parent[b.remoteDataField+"sSelect"]=f}else if("function"==typeof b.dataSource){var i=b.queryParams||{};b.queryWithExistsData&&angular.forEach(b.queryWithExistsData,function(a){i[a]=void 0!==b["data-row-index"]?c.$parent[g.opts.dataName][b["data-row-index"]][a]:c.$parent[g.opts.dataName][a]}),b.dataSource.query(i).$promise.then(function(a){angular.forEach(a,function(a){f.push({value:a[d],name:a[e]})}),c.$parent[b.remoteDataField+"sSelect"]=f})}return sprintf(this.$parent.templates["fields/select"],{attr:this._attr(a,b),key:a+"item",data:b.remoteDataField+"sSelect"})},_select3:function(a,b,c){var d=a+"Select3Config";return b.dataName=this.opts.dataName,c.$parent[d]={name:a,fieldDefine:b},sprintf('<select3 config="%s"></select3>',d)},_select2:function(a,b,c){var d,e=a+"DataSource",f=b.nameField||"name",g=b.valueField||"id",h=this;d=$.extend(b.queryParams||{},{});var i;c.$parent[e]=void 0,c.$parent[e+"_refresh"]=function(a){i!==a&&(i=a,b.queryWithExistsData&&angular.forEach(b.queryWithExistsData,function(a){d[a]=void 0!==b["data-row-index"]?c.$parent[h.opts.dataName][b["data-row-index"]][a]:c.$parent[h.opts.dataName][a]}),d=$.extend(b.queryParams||{},{typeahead:a}),b.dataSource.query(d,function(a){var b=[];angular.forEach(a,function(a){b.push({label:a[f],value:a[g],category:a.goods_category_id,factory_code:a.factory_code})}),c.$parent[e]=b}))};var j=sprintf(this.$parent.templates["fields/select2"],{method:e,data:a,key:"forkey",label:f,model:b["ng-model"],event:b["ui-event"]?sprintf('ui-event="%s"',b["ui-event"]):"",attrs:this._attr(a,b)});return j},_typeahead:function(a,b,c){var d,e=a+"DataSource",f=b.nameField||"name",g=b.valueField||"id";d=$.extend(b.queryParams||{},{}),c.$parent[e]=function(a){d=$.extend(b.queryParams||{},{typeahead:a});var c=$q.defer();return b.dataSource.query(d,function(a){var b=[];angular.forEach(a,function(a){b.push({label:a[g]+"_"+a[f],value:a[g],category:a.goods_category_id,factory_code:a.factory_code})}),c.resolve(b)}),c.promise.then(function(a){return a})},b.value&&(c.$parent[a+"TAIT"]=b.value);var h=sprintf(this.$parent.templates["fields/typeahead"],{key:a+"item",data:e,attr:this._attr(a,b)});return h}},service.makeBill=function(a){var b={minRows:9,dataName:"formData",autoFocusNext:!0,methods:{}};this.opts=$.extend(b,a.config),this.scope=a,this.compile=$compile,this.scope.$parent[this.opts.dataName]=[],this.opts.templates=this.templates={"bills/box.html":'<table class="table table-bordered" id="billTable"><thead><tr><th>#</th><th></th>%(headHTML)s</tr></thead><tbody>%(bodyHTML)s</tbody><tfoot><tr>%(footHTML)s</tr></tfoot></table>',"bills/fields/rowHead.html":'<th>%(i)s</th><td class="center"><label class="rowHead"><i class="icon icon-plus" ng-click="billAddRow($event.target)"></i> <i class="icon icon-trash" ng-click="billRemoveRow($event.target)"></i> </label></td>',"bills/fields/td.html":'<td class="%(tdClass)s" data-input-type="%(type)s" data-bind-model="%(field)s"><label ng-bind="%(bind)s" %(event)s>%(label)s</label></td>',"bills/fields/typeaheadList.html":'<ul class="typeAheadList editAble" /><li ng-repeat="%(v)s in %(data)s" type="typeahead" data-typeahead-value="%(v)s.%(valueField)s" ng-click="billTypeaheadClick($event)">{{%(v)s.%(labelField)s}}</li></ul>'},this.opts.storeAPI=StockProductListRes,this.fm=new service.makeField(a,{multi:!0,dataName:this.opts.dataName})},service.makeBill.prototype={makeHTML:function(){return this.bindEvents(this.scope),sprintf(this.opts.templates["bills/box.html"],{headHTML:this.makeHead(this.opts.fieldsDefine),bodyHTML:this.makeBody(this.opts.fieldsDefine),footHTML:this.makeFoot(this.opts.fieldsDefine)})},makeHead:function(a){var b=[];return angular.forEach(a,function(a){if(a.billAble!==!1){var c=[];a&&"width"in a&&c.push('width="'+a.width+'"'),b.push(sprintf("<th %s>%s</th>",c.join(""),a.displayName))}}),b.join("")},makeBody:function(a){var b=[],c=this,d=c.scope.$parent.formMetaData.rows||[];this.scope.$parent.formMetaData.rows=d=dataFormat(a,d);for(var e=d.length||c.opts.minRows,f=0;e>f;f++)b.push(this.makeRow(a,f,d));return b.join("");var f},makeFoot:function(a){var b=['<td colspan="2" align="center">'+this.scope.$parent.i18n.lang.total+"</td>"];return angular.forEach(a,function(a,c){a.billAble!==!1&&b.push(a.totalAble?sprintf('<td class="tdTotalAble" tdname="%(field)s" id="tdTotalAble%(field)s" ng-bind="%(dataBind)s">0</td>',{field:c,dataBind:a.cellFilter?"formMetaData.total_"+c+"|"+a.cellFilter:"formMetaData.total_"+c}):"<td></td>")}),sprintf("<tr>%s</tr>",b.join(""))},makeRow:function(a,b,c){var d=this,e=[this.opts.templates["bills/fields/rowHead.html"]];c=c||[],c=dataFormat(a,c),this.scope.$parent[this.opts.dataName][b]=c[b]||{};var f,g;return angular.forEach(a,function(a,h){if(a.billAble!==!1){if(c.length){var i=d.scope.$parent[d.opts.dataName][b];a.field+"_label"in i?(i[a.field+"_label"]=c[b][a.field+"_label"],g=sprintf("%s[%d].%s_label",d.opts.dataName,b,h)):g=sprintf("%s[%d].%s",d.opts.dataName,b,h)}else g=sprintf("%s[%d].%s",d.opts.dataName,b,a.labelField?h+"_label":h);a.cellFilter&&(g=sprintf("%s|%s",g,a.cellFilter)),a.inputType=a.inputType?a.inputType:"text",e.push(sprintf(d.templates["bills/fields/td.html"],{field:h,type:a.inputType,tdClass:!1!==a.editAble?"tdEditAble":"",event:!1!==a.editAble?'ng-click="billFieldEdit($event.target)"':"",label:f,bind:g}))}}),this.maxTrId=b,sprintf('<tr data-trid="%s">%s</tr>',b,sprintf(e.join(""),{i:b+1}))},bindEvents:function(a){var b=this;a.$parent.billFieldEdit=function(c){var d=getLabelContext(c);if(d.td.find(".editAble").length)return d.td.find(".editAble").removeClass("hide").find("input"),void d.inputAble.trigger("click").focus();var e=b.opts.fieldsDefine[d.field];if(e.class="width-100 editAble",e.remoteDataField=sprintf("%s_%d",d.field,d.trid),e["ng-model"]=sprintf("%s[%d].%s",b.opts.dataName,d.trid,d.field),e.editAbleRequire)if(e.editAbleRequire instanceof Array){for(var f=0;f<e.editAbleRequire.length;f++)if(e.editAbleRequire[f],!a.$parent[b.opts.dataName][d.trid]||!a.$parent[b.opts.dataName][d.trid][e.editAbleRequire[f]])return!1}else if(!a.$parent[b.opts.dataName][d.trid]||!a.$parent[b.opts.dataName][d.trid][e.editAbleRequire])return!1;var g=["blur","click","keydown","focus","change"],h=[];angular.forEach(g,function(b){var c=sprintf("on%s%s%s",d.field.ucfirst(),d.inputType.ucfirst(),b.ucfirst());c in a.$parent?h.push(sprintf("%s:'%s($event)'",b,c)):(c=sprintf("on%s%s",d.inputType.ucfirst(),b.ucfirst()),c in a.$parent&&h.push(sprintf("%s:'%s($event)'",b,c)))}),h.length&&(e["ui-event"]=sprintf("{%s}",h.join()));var i=b.fm.maker.factory(d,e,a);i=b.compile(i)(a.$parent),d.td.append(i),setTimeout(function(){d=getInputContext(c),d.inputAble.trigger("click").focus(),d.inputAble.bind("keydown",function(a){13==a.keyCode&&b.scope.$parent.billEndEdit(d.td)})},100)},a.$parent.billEndEdit=function(a,c){var d=!1,e=a.parent().find(".tdEditAble"),f=[];angular.forEach(e,function(a){f.push(a)}),f.length>1&&f.indexOf(a[0])+1<f.length&&(d=$(f).eq(f.indexOf(a[0])+1)),b.opts.autoFocusNext&&!c&&(d||(a.parent().index()+1>=$("#billTable tbody tr").length&&b.scope.$parent.billAddRow(null,!0),d=$("#billTable tbody tr").eq(a.parent().index()+1).find("td.tdEditAble").eq(0)),setTimeout(function(){b.scope.$parent.billFieldEdit($(d).find("label"))})),b.scope.editing=!1},a.$parent.billAddRow=function(a,c){var d=b.makeRow(b.opts.fieldsDefine,b.maxTrId+1);d=b.compile(d)(b.scope.$parent),!0===c?$("#billTable tbody").append(d):$(a).parent().parent().parent().before(d),b.reIndexTr()},a.$parent.billRemoveRow=function(c){if($("#billTable tbody tr").length<3)return void alert("at least 2 rows");var d=$(c).parents("tr");delete a.$parent[b.opts.dataName][d.data("trid")],d.remove(),b.reIndexTr()},a.$parent.onTextBlur=function(c){var d=$(c.target);a.$parent.billEndEdit(d.parent(),!0),b.setData(d,d.val(),!0)},a.$parent.onTextKeydown=function(a){if(9!=a.keyCode||a.shiftKey)if(13==a.keyCode){var c=$(a.target);b.setData(c,c.val())}else a.shiftKey&&9==a.keyCode&&(window.event.returnValue=!1);else{window.event.returnValue=!1;var c=$(a.target);b.setData(c,c.val())}},void 0===a.$parent.onNumberBlur&&(a.$parent.onNumberBlur=function(c){var d=$(c.target);a.$parent.billEndEdit(d.parent(),!0),b.setNumberData(d,d.val(),!0)}),a.$parent.onNumberKeydown=function(a){if(9!=a.keyCode||a.shiftKey)if(13==a.keyCode){var c=$(a.target);b.setNumberData(c,c.val())}else a.shiftKey&&9==a.keyCode&&(window.event.returnValue=!1);else{window.event.returnValue=!1;var c=$(a.target);b.setNumberData(c,c.val())}},a.$parent.onTypeaheadBlur=function(a){var c=$(a.target);b.setTypeaheadData(c,b.scope,!0)},a.$parent.onTypeaheadKeydown=function(a){if(9==a.keyCode){window.event.returnValue=!1;var c=$(a.target);b.setTypeaheadData(c,b.scope)}else if(13==a.keyCode){var c=$(a.target);b.setTypeaheadData(c,b.scope)}},a.$parent.onSelect2Keydown=function(){console.log(arguments)},a.$parent.onStockSelect3Blur=function(a){var c=getInputContext(a.target),d=b.scope.$parent[b.opts.dataName][c.trid],e={id:0,stock_id:d.stock};e.factory_code_all=d.factory_code_all?d.factory_code_all:sprintf("%s-%s-%s",d.goods_id.split("_")[0],d.standard,d.version),b.opts.storeAPI.get(e).$promise.then(function(a){b.scope.$parent[b.opts.dataName][c.trid].store_num=a.num||0})}},reIndexTr:function(){var a=$("#billTable tbody tr"),b=1;angular.forEach(a,function(a){$(a).find("th:first").html(b),b++})},setNumberData:function(a,b,c){if($(a).attr("totalAble")){var d=0,e=getInputContext(a);angular.forEach(this.scope.$parent[this.opts.dataName],function(a){e.field in a&&(d+=parseFloat(a[e.field]))}),d=d.toFixed(2),b=parseFloat(b).toFixed(2),this.scope.$parent.formMetaData["total_"+e.field]=d,this.setData(a,b,c)}else this.setData(a,b,c)},setData:function(a,b,c){var d=getInputContext(a);d.td.find(".editAble").addClass("hide"),this.scope.$parent.billEndEdit(d.td,c)},setTypeaheadData:function(a,b,c){var d,e=getInputContext(a),f=this;setTimeout(function(){b.$parent[f.opts.dataName][e.trid][e.field]?d=e.ele.val():e.ele.val(""),e.td.find("label").text(d),e.td.find(".editAble").addClass("hide"),b.$parent.billEndEdit(e.td,c)},200)}},service.makeForm=function(a){this.scope=a;var b=a.$parent.config||{};if(!b.fieldsDefine)return!1;var c={"class":"form-horizontal",submitAction:"doSubmit",fieldsDefine:{},templates:{"commonForm/form.html":'<form class="form-horizontal" name="%(name)s" ng-keydown="doKeydown($event)" novalidate>%(html)s</form>',"commonForm/footer.html":'<div class="clearfix form-actions"><div class="col-md-offset-2 col-md-9"><button id="submitbtn" class="btn btn-primary" ng-click="%(action)s();" type="button"><i class="icon-ok bigger-110"></i>{{%(langsubmit)s}}</button>&nbsp; &nbsp; &nbsp;<button class="btn" type="reset"><i class="icon-undo bigger-110"></i>{{%(langreset)s}}</button>&nbsp; &nbsp; &nbsp;<button class="btn btn-info" onclick="history.back()"><i class="icon-undo bigger-110"></i>{{%(langreturn)s}}</button></div></div>',"commonForm/box.html":'<div class="form-group" ng-class="{\'has-error\': %(formname)s.%(fieldname)s.$dirty&&%(formname)s.%(fieldname)s.$invalid}"><label class="col-sm-3 control-label no-padding-right">%(label)s</label><div class="col-xs-12 col-sm-4">%(inputHTML)s</div><div class="help-block col-xs-12 col-sm-reset" ng-hide="!%(formname)s.%(fieldname)s.$dirty||%(formname)s.%(fieldname)s.$valid">{{%(formname)s.%(fieldname)s.$error}}</div></div>',text:'<input type="text" %s />',number:'<input type="number" %s />',select:'<select %(attr)s ng-options="%(value)s as %(name)s for %(key)s in %(data)s"></select>'},dataName:""};
this.opts=$.extend(!0,c,b),this.opts.dataName=this.opts.dataName?this.opts.dataName:this.opts.name+"Data",a.$parent[this.opts.dataName]=a.$parent[this.opts.dataName]||{},a[this.opts.dataName]={},a.$parent.doKeydown=function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())},this.fm=new service.makeField(a,this.opts)},service.makeForm.prototype={makeHTML:function(){if(!this.scope.formBuilded){var a,b=this,c=[],d=this.opts.templates["commonForm/box.html"];return angular.forEach(this.opts.fieldsDefine,function(e,f){e.class="width-100",e["ng-model"]=b.opts.dataName+"."+f,e.required!==!1?e.required="required":delete e.required,e.value&&(b.scope.$parent[b.opts.dataName][f]=e.value),e.hideInForm||e.primary||(b.scope.$parent[b.opts.dataName][f]="",a=b.fm.maker.factory({field:f},e,b.scope),0!=a&&c.push(sprintf(d,{formname:b.opts.name,fieldname:e.name?e.name:f,label:e.displayName,inputHTML:a})))}),c.push(this.makeActions()),b.scope.formBuilded=!0,sprintf(b.opts.templates["commonForm/form.html"],{name:b.opts.name,html:c.join("")})}},makeActions:function(){return sprintf(this.opts.templates["commonForm/footer.html"],{action:this.opts.submitAction,langsubmit:"i18n.lang.actions.submit",langreset:"i18n.lang.actions.reset",langreturn:"i18n.lang.actions.return"})}},service.select3=function(a){this.defaultOpts={autoQuery:!1,inputTpl:'<input type="text" ng-model="%(model)s_label" %(attr)s /><input type="hidden" ng-model="%(model)s" />',selectTpl:'<ul class="select3Container" id="select3Container"><li ng-repeat="s3it in select3Items" ng-class="{active:$index==selectedItem}" data-value="{{s3it.value}}" ng-bind="s3it.label" ui-event="%(events)s"></li></ul>'};var b={};$.extend(b,this.defaultOpts),a.$parent.select3Configs=a.$parent.select3Configs||{},a.$parent.select3Configs[a.config.fieldDefine.field]=a.config.fieldDefine,this.opts=$.extend(b,a.$parent.select3Configs[a.config.fieldDefine.field]),this.scope=a},service.select3.prototype={makeHTML:function(){this.bindEvents();var events={focus:"'doSelect3Focus($event)'",blur:"'doSelect3Blur($event)'",keydown:"'doSelect3Keydown($event)'"};if(this.opts["ui-event"]){var tmpEvents;eval("tmpEvents="+this.opts["ui-event"]),angular.forEach(tmpEvents,function(a,b){b in events&&(events[b]=events[b].replace(")'",");"+a+"'"))})}events=$.extend(events,this.opts.events);var attrs=[["ui-event",angular.toJson(events).replace(/"/g,"")],["class","select3Input editAble"],["data-field",this.opts.field]],attrHTML=[];angular.forEach(attrs,function(a){attrHTML.push(sprintf('%s="%s"',a[0],a[1]))});var html=sprintf(this.opts.inputTpl,{attr:attrHTML.join(" "),model:this.opts["ng-model"]});return html},bindEvents:function(){var a=this;this.scope.$parent.doSelect3Focus=function(b){var c={};$.extend(c,a.defaultOpts),a.opts=$.extend(c,a.scope.$parent.select3Configs[$(b.target).data("field")]);var d=b.target.value;(a.opts.autoReset||!d&&a.opts.autoQuery)&&(d="_"),d&&a.scope.$parent.doSelect3Query(d)},this.scope.$parent.doSelect3Keydown=function(b){var c={Enter:13,Tab:9,Up:38,Down:40,Escape:27};setTimeout(function(){switch(b.keyCode){case c.Enter:if(!$("#select3Container li").length)return!1;a.scope.setValue($("#select3Container li.active"));break;case c.Tab:case c.Escape:a.scope.$parent.hideSelect3Options();break;case c.Up:if(!a.scope.select3Items.length)return;a.scope.selectedItem-1<0?a.scope.selectedItem=a.scope.select3Items.length-1:a.scope.selectedItem--;break;case c.Down:if(!a.scope.select3Items.length)return;a.scope.selectedItem+1>=a.scope.select3Items.length?a.scope.selectedItem=0:a.scope.selectedItem++;break;default:$(b.target).is("input")&&a.scope.$parent.doSelect3Query(b.target.value)}})},this.scope.$parent.doSelect3Query=function(b){if(a.scope.select3Items=[],angular.isArray(a.opts.dataSource)){if(a.opts.dataSource.length<1)return a.scope.$parent.hideSelect3Options(!0),void console.log("no result");angular.forEach(a.opts.dataSource,function(b){a.scope.select3Items.push({label:b[a.opts.nameField||"name"],value:b[a.opts.valueField||"id"]})}),a.scope.$parent.displaySelect3Options()}else{if(!$.trim(b))return void a.scope.$parent.hideSelect3Options(!0);var c=a.opts.queryParams||{};c.typeahead=$.trim(b),"queryWithExistsData"in a.opts&&angular.forEach(a.opts.queryWithExistsData,function(b){c[b]=void 0!==a.opts["data-row-index"]?a.scope.$parent[a.opts.dataName][a.opts["data-row-index"]][b]:a.scope.$parent[a.opts.dataName][b]}),a.opts.dataSource.query(c).$promise.then(function(b){return b.length<1?(a.scope.$parent.hideSelect3Options(!0),void console.log("no result")):(angular.forEach(b,function(b){a.scope.select3Items.push({label:b[a.opts.nameField||"name"],value:b[a.opts.valueField||"id"]})}),void a.scope.$parent.displaySelect3Options())})}},this.scope.$parent.doSelect3Blur=function(){a.scope.$parent.hideSelect3Options()},this.scope.$parent.displaySelect3Options=function(){if(!$("#select3Container").length){var b=sprintf(a.opts.selectTpl,{events:"{keydown:'doSelect3Keydown($event)', click:'doSelect3Click($event)'}"}),c=$compile(b)(a.scope);$("body").append(c);var d=$(".select3Input:focus");$("#select3Container").css({minWidth:d.outerWidth(),left:d.offset().left,top:d.offset().top+d.outerHeight()}),a.scope.selectedItem=0}},this.scope.$parent.hideSelect3Options=function(b){b||$(".select3Input:focus").blur(),!b&&a.opts.autoHide,$("#select3Container").remove(),a.scope.select3Items=[]},this.scope.doSelect3Click=function(b){a.scope.setValue(b.target)},this.scope.setValue=function(b){var c=$parse(a.opts["ng-model"]);c.assign(a.scope.$parent,$(b).data("value")),c=$parse(a.opts["ng-model"]+"_label"),c.assign(a.scope.$parent,$(b).text()),a.scope.$parent.hideSelect3Options()}}},service}])}(),Array.prototype.in_array=function(a){for(i=0;i<this.length;i++)if(this[i]==a)return!0;return!1},Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1},Array.prototype.remove=function(a){var b=this.indexOf(a);b>-1&&this.splice(b,1)},String.prototype.ucfirst=function(){for(var a=this.split(/\s+/g),b=0;b<a.length;b++){var c=a[b].match(/(\w)(\w*)/);a[b]=c[1].toUpperCase()+c[2]}return a.join(" ")};var dataFormat=function(a,b){if(b instanceof Array){for(var c=0;c<b.length;c++)b[c]=dataFormat(a,b[c]);return b}for(var d in a){var e=a[d];switch(e.inputType){case"number":!1===isNaN(b[d])&&(b[d]=Number(b[d]));break;default:b[d]=b[d]}}return b},getInputContext=function(a){var b={};return b.ele=$(a),b.eleValue=b.ele.val(),b.td=b.ele.parent(),b.label=b.td.find("label"),b.tr=b.td.parent(),b.trid=b.index=b.tr.data("trid"),b.field=b.td.data("bind-model"),b.inputType=b.td.data("input-type"),b.inputAble=b.td.find("input"),b},getLabelContext=function(a){var b={};return b.ele=$(a),b.td=b.ele.parent(),b.tr=b.td.parent(),b.trid=b.index=b.tr.data("trid"),b.field=b.td.data("bind-model"),b.text=b.ele.text(),b.inputType=b.td.data("input-type"),b.inputAble=b.td.find("input"),b};!function(a){function b(a){return Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function c(a,b){for(var c=[];b>0;c[--b]=a);return c.join("")}var d=function(){return d.cache.hasOwnProperty(arguments[0])||(d.cache[arguments[0]]=d.parse(arguments[0])),d.format.call(null,d.cache[arguments[0]],arguments)};d.format=function(a,e){var f,g,h,i,j,k,l,m=1,n=a.length,o="",p=[];for(g=0;n>g;g++)if(o=b(a[g]),"string"===o)p.push(a[g]);else if("array"===o){if(i=a[g],i[2])for(f=e[m],h=0;h<i[2].length;h++){if(!f.hasOwnProperty(i[2][h]))throw d('[sprintf] property "%s" does not exist',i[2][h]);f=f[i[2][h]]}else f=i[1]?e[i[1]]:e[m++];if(/[^s]/.test(i[8])&&"number"!=b(f))throw d("[sprintf] expecting number but found %s",b(f));switch(i[8]){case"b":f=f.toString(2);break;case"c":f=String.fromCharCode(f);break;case"d":f=parseInt(f,10);break;case"e":f=i[7]?f.toExponential(i[7]):f.toExponential();break;case"f":f=i[7]?parseFloat(f).toFixed(i[7]):parseFloat(f);break;case"o":f=f.toString(8);break;case"s":f=(f=String(f))&&i[7]?f.substring(0,i[7]):f;break;case"u":f>>>=0;break;case"x":f=f.toString(16);break;case"X":f=f.toString(16).toUpperCase()}f=/[def]/.test(i[8])&&i[3]&&f>=0?"+"+f:f,k=i[4]?"0"==i[4]?"0":i[4].charAt(1):" ",l=i[6]-String(f).length,j=i[6]?c(k,l):"",p.push(i[5]?f+j:j+f)}return p.join("")},d.cache={},d.parse=function(a){for(var b=a,c=[],d=[],e=0;b;){if(null!==(c=/^[^\x25]+/.exec(b)))d.push(c[0]);else if(null!==(c=/^\x25{2}/.exec(b)))d.push("%");else{if(null===(c=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b)))throw"[sprintf] huh?";if(c[2]){e|=1;var f=[],g=c[2],h=[];if(null===(h=/^([a-z_][a-z_\d]*)/i.exec(g)))throw"[sprintf] huh?";for(f.push(h[1]);""!==(g=g.substring(h[0].length));)if(null!==(h=/^\.([a-z_][a-z_\d]*)/i.exec(g)))f.push(h[1]);else{if(null===(h=/^\[(\d+)\]/.exec(g)))throw"[sprintf] huh?";f.push(h[1])}c[2]=f}else e|=2;if(3===e)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";d.push(c)}b=b.substring(c[0].length)}return d};var e=function(a,b,c){return c=b.slice(0),c.splice(0,0,a),d.apply(null,c)};a.sprintf=d,a.vsprintf=e}("undefined"!=typeof exports?exports:window),angular.module("erp.passport",["erp.passport.services","ngGrid","erp.common.directives"]).config(["$routeProvider",function(a){a.when("/Passport/AuthGroup/viewSub/id/:pid",{templateUrl:"views/passport/assignPermission.html",controller:"AuthGroupAssignPermissionCtl"}).when("/Passport/AuthGroup",{templateUrl:"views/common/grid.html",controller:"AuthGroupCtl"}).when("/Passport/Department",{templateUrl:"views/common/grid.html",controller:"DepartmentCtl"}).when("/Passport/Department/add/pid/:pid",{templateUrl:"views/common/edit.html",controller:"DepartmentEditCtl"}).when("/Passport/Department/edit/id/:id",{templateUrl:"views/common/edit.html",controller:"DepartmentEditCtl"}).when("/Passport/Logout",{templateUrl:"views/common/blank.html",controller:"LogoutCtl"})}]).controller("LogoutCtl",["$scope","$http","erp.config",function(a,b,c){b.get(c.BSU+"passport/userLogout").success(function(){window.location.href="index.html"})}]).controller("AuthGroupAssignPermissionCtl",["$scope","AuthGroupRuleRes","$routeParams",function(a,b,c){a.permissionData=[],a.selectAble=!1,a.dataList=[],b.query({id:c.pid}).$promise.then(function(b){a.permissionData=b.selected||[],a.dataList=b.rules||{}}),a.doSubmit=function(){b.update({id:c.pid},a.permissionData).$promise.then(function(){})}}]).controller("AuthGroupCtl",["$scope","AuthGroupModel","AuthGroupRes","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/Passport/AuthGroup/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/AuthGroup/"}],a.viewSubAble=!0,d.displayGrid(a,b,c)}]).controller("AuthGroupEditCtl",["$scope","AuthGroupModel","AuthGroupRes","ComView","$routeParams",function(a,b,c,d,e){a.selectAble=!1,a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/Passport/AuthGroup/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/AuthGroup/"}],d.displayForm(a,b,c,{id:e.id})}]).controller("DepartmentCtl",["$scope","DepartmentModel","DepartmentRes","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/Department/"}],a.addChildAble=!0,d.displayGrid(a,b,c,{multiSelect:!1})}]).controller("DepartmentEditCtl",["$scope","DepartmentModel","DepartmentRes","ComView","$routeParams",function(a,b,c,d,e){a.selectAble=!1,a.pageActions=[{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/Department/"}],d.displayForm(a,b,c,{id:e.id})}]).controller("AuthRuleCtl",["$scope","AuthRuleModel","AuthRuleRes","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/AuthRule/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/AuthRule/"}],d.displayGrid(a,b,c)}]).controller("AuthRuleEditCtl",["$scope","AuthRuleModel","AuthRuleRes","ComView","$routeParams",function(a,b,c,d,e){a.selectAble=!1,a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/HOME/AuthRule/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/HOME/AuthRule/"}],d.displayForm(a,b,c,{id:e.id})}]).controller("UserListCtl",["$scope","UserModel","UserRes","ComView",function(a,b,c,d){a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/Passport/User/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/User/"}],d.displayGrid(a,b,c)}]).controller("UserEditCtl",["$scope","UserModel","UserRes","ComView","$routeParams",function(a,b,c,d,e){a.selectAble=!1,a.pageActions=[{label:a.i18n.lang.actions.add,"class":"success",href:"/Passport/User/add"},{label:a.i18n.lang.actions.list,"class":"primary",href:"/Passport/User/"}],d.displayForm(a,b,c,{id:e.id},!0)}]),angular.module("erp.passport.services",[]).factory("UserModel",["DepartmentRes","AuthGroupRes","$q","$rootScope",function(a,b,c,d){var e={getFieldsStruct:function(e){var f={id:{primary:!0},email:{inputType:"email"},username:{},password:{inputType:"password",listable:!1,required:!1},truename:{},phone:{inputType:"number"},group_name:{displayName:d.i18n.lang.usergroup,field:"usergroup",hideInForm:!0},usergroup:{inputType:"select",multiple:"multiple",nameField:"title",valueField:"id",listable:!1},department:{field:"Department.name",hideInForm:!0},department_id:{displayName:d.i18n.lang.department,nameField:"prefix_name",listable:!1,inputType:"select"}};if(e)return f;var g=c.defer();return a.query().$promise.then(function(a){f.department_id.dataSource=a},function(){g.reject()}).then(function(){b.query().$promise.then(function(a){f.usergroup.dataSource=a,g.resolve(f)})}),g.promise}};return e}]).factory("AuthRuleModel",["$rootScope",function(){return{getFieldsStruct:function(){return{id:{primary:!0},name:{},title:{},category:{inputType:"select",dataSource:[{id:"accounting",name:"高级财务模块"},{id:"all",name:"公用模块"},{id:"basedata",name:"基础数据"},{id:"crm",name:"客户管理"},{id:"finance",name:"基本财务模块"},{id:"produce",name:"生产管理"},{id:"sale",name:"销售模块"},{id:"set",name:"设置模块"},{id:"statistics",name:"统计模块"},{id:"stock",name:"仓储管理"}]}}}}}]).factory("DepartmentModel",["$rootScope",function(a){return{subAble:!0,viewSubAble:!1,getFieldsStruct:function(){var b=a.i18n.lang;return{id:{primary:!0},name:{displayName:b.category,listable:!1},prefix_name:{hideInForm:!0,displayName:b.category}}}}}]).factory("AuthGroupModel",["$rootScope",function(a){return{getFieldsStruct:function(){var b=a.i18n.lang;return{id:{primary:!0},title:{displayName:b.name}}}}}]);